name: Markdown → PDF with timestamps

on:
  push:
    branches:
      - main
    paths:
      - '*.MD'


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed .MD files
        id: changed
        run: |
          mkdir _tmp_md
          files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^[^/]+\.MD$' || true)
          echo "changed=$files" >> $GITHUB_OUTPUT
          echo "Changed files: $files"

      - name: Stop if nothing changed
        if: steps.changed.outputs.changed == ''
        run: echo "No root-level markdown files changed. Skipping."

      - name: Copy changed files into temp directory
        if: steps.changed.outputs.changed != ''
        run: |
          for f in ${{ steps.changed.outputs.changed }}; do
            cp "$f" "_tmp_md/"
          done

      - name: Convert MD → PDF using BaileyJM02 action
        if: steps.changed.outputs.changed != ''
        uses: baileyjm02/markdown-to-pdf@v1
        with:
          input_path: _tmp_md
          output_dir: _pdf_raw
          build_pdf: true
          build_html: false

      - name: Rename PDFs with timestamp & move to versions/
        if: steps.changed.outputs.changed != ''
        run: |
          mkdir -p versions
          timestamp=$(date +'%Y%m%d%H%M%S')
          for f in _pdf_raw/*.pdf; do
            base=$(basename "$f" .pdf)
            newname="${base}_${timestamp}.pdf"
            mv "$f" "versions/$newname"
            echo "Created versions/$newname"
          done

      - name: Commit generated PDFs
        if: steps.changed.outputs.changed != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add versions/
          git commit -m "Generated PDF versions"
          git push